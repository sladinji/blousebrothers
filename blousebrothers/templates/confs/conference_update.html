{% extends "layout.html" %}
{% load static %}{% load i18n %}
{% load djng_tags %}
{% block title %}{% trans 'Confs' %}{% endblock %}

{% block submenu %}
	<p class="blouse-font">{% trans "Rédaction d'un sujet" %}</p>
{% endblock %}

{% block content %}
<div class="ng-scope" ng-app='djangular-bb'>
<div ng-controller="ConfFormCtrl" class="container" ng-cloak >

    <div class='row'>
	<aside class="col-md-3 col-sm-12">
	    {% verbatim %}
	    <div ng-app="myShoppingList" class="bb-card-2 bb-margin">
	    <header class="bb-container bb-light-grey bb-padding-16">
	    <h3>Questions</h3>
	    <div ng-if="!question">
		    <p>Commencez à ajouter des questions :</p>
	    </div> 
	    </header>
	    <ul class="bb-ul">
		    <li ng-repeat="x in questions" class="bb-padding-16"><a href ng-click="question_selected(x)"><i class="fa fa-comment fa-fw"></i>{{ $index + 1 }} : {{x.question | limitTo: 20}} ...</a></li>
	    </ul>
	    <div class="bb-container bb-light-grey bb-padding-16">
		<div class="row bb-margin-top"></div>
		<p class="bb-padding-left bb-text-red">{{errortext}}</p>
	    </div>
	    </div>
	    {% endverbatim %}
	</aside>

	<div id="subject" class="col-md-9" >
	  {% verbatim %}
	  <legend>Sujet</legend>
	  <form novalidate class="question-form">
	  <input type="text" class="no-border-form form-control" ng-model="conference.title" placeholder="Titre"/><br />
	  <textarea type="text" class="no-border-form form-control" ng-model="conference.statement" placeholder="Énoncé" rows="10"></textarea><br />
	  </form>
	  <a class="btn" ng-click="isImagesDiplayed = !isImagesDiplayed">
		<div ng-if="isImagesDiplayed">
		  Masquer les illustrations
		</div>
		<div ng-if="!isImagesDiplayed">
		  Afficher les illustrations
		</div>
	  </a>
	  <br>
	  <div class="illustrations" ng-show="isImagesDiplayed" id="images_div">
	    <div ng-repeat="image in conferenceimages">
	      <img src="{{ static_media(image.image) }}"/>
	    </div>
	  </div>
		
	  
	  <div ng-if="question">
	    <legend>Question {{ question.index + 1 }}</legend>
	    <form novalidate class="question-form">
		    <textarea type="text" class="no-border-form form-control" ng-model="question.question" placeholder="Énoncé"></textarea><br />
	    </form>
	          
	    <form class="form-horizontal">
	    <fieldset>
	    <legend>Réponses</legend>
	    <div class="well well-white" ng-repeat="answer in answers">
	      <span class='well-title'>{{ans_label[answers.indexOf(answer)]}}</span>
	      <div class="form-group">
	        <div class="col-sm-12">
	          	<input ng-model="answer.answer" class="material_form form-control" placeholder="Réponse {{ans_label[answers.indexOf(answer)]}}" required="true" type="text"/>
	             <label><input type="checkbox" ng-model="answer.correct"/> Correcte ?</label>
	        </div>
	      </div>
	      <div class="form-group">
	        <div class="col-sm-12">
	        <input ng-model="answer.explaination" placeholder="Explication" class="material_form form-control input-md" type="text">
	          
	        </div>
	      </div>

	    </div>
	    </fieldset>
	    </form>
	  </div> 
	  {% endverbatim %}
	</div>
    </div>

</div>
</div>
{% endblock content %}


{% block scripts %}
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.20/angular.min.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.20/angular-resource.min.js" type="text/javascript"></script>
<script src="{% static 'djng/js/django-angular.min.js' %}" type="text/javascript"></script>
<script type="text/javascript">
{% comment %}

{% endcomment %}
var STATIC_URL = '{{ STATIC_URL|escapejs }}';
var MEDIA_URL  = '{{ MEDIA_URL|escapejs }}';

function static(path) {
    return STATIC_URL + path;
}
function static_media(path) {
    return MEDIA_URL + path;
}
var conf_app = angular.module('djangular-bb', ['djng.rmi', 'ngResource', 'djng.forms']);
{% if object %}
var slug="{{ object.slug }}"
{% else %}
var slug=""
{% endif %}

conf_app.factory('Question', ['$resource', function($resource) {
	return $resource('{% url 'confs:question_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_app.factory('Conference', ['$resource', function($resource) {
	return $resource('{% url 'confs:conference_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_app.factory('ConferenceImage', ['$resource', function($resource) {
	return $resource('{% url 'confs:conferenceimage_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_app.factory('Answer', ['$resource', function($resource) {
	return $resource('{% url 'confs:answer_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_app.config(function($httpProvider) {
	    $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
	    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
	    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});
var tags = {% djng_current_rmi %};
conf_app.config(function(djangoRMIProvider) {
    djangoRMIProvider.configure(tags);
});

conf_app.controller('ConfFormCtrl', function($scope, $http, $window, djangoForm) {
    $scope.submit = function() {
	if ($scope.conf_data) {
		$http.post(".", $scope.conf_data).success(function(out_data) {
			if (!djangoForm.setErrors($scope.conf_form, out_data.errors)) {
				// on successful post, redirect onto success page
				$window.location.href = out_data.success_url;
			}
		}).error(function() {
		console.error('An error occured during submission');
		});
	}
	return false;
    }
});

conf_app.controller("ConfFormCtrl", function($scope, $timeout, djangoRMI, Conference, ConferenceImage, Question, Answer) {
    $scope.ans_label = ["A", "B", "C", "D", "E"];
    $scope.conferenceimages = [];
    $scope.static_media = static_media;
    var setAnswers = function(question) {
	if (question != null){
		Answer.query({question: question.pk}).$promise
		.then(function(result){
			$scope.answers = result;
			$scope.answers.length = 5;
		})
	}
    };
    $scope.question_selected = function(question){
    	$scope.question = question;
    	setAnswers(question);
    }

    $scope.init_model = function () {
	$scope.questions = [];
	$scope.answers = [];
	$scope.conferenceimages = [];
	$scope.question = null;
	if (slug != ""){
		Conference.get({slug: slug}).$promise
    		.then(function(result){
    			$scope.conference = result;
			Question.query({conf: $scope.conference.pk}).$promise
    			.then(function(result){
				$scope.questions = result;
				$scope.question = $scope.questions[0];
    				setAnswers($scope.question);
    			})
			ConferenceImage.query({conf: $scope.conference.pk}).$promise
    			.then(function(result){
				$scope.conferenceimages= result;
    			})
    		})
	}
	else{
		$scope.showsubject = true;
	}
    }
    // init model on load
    $scope.init_model();

    // START AUTO SAVE
    var timeout = null;
    var saveUpdates = function() {
      // .... save data to server
      djangoRMI.sync_data([$scope.conference, $scope.question, $scope.answers])
	 .success(function(out_data) {
	     $scope.remote = out_data;
	 });
    };
    var debounceSaveUpdates = function(newVal, oldVal) {
      console.log(newVal, oldVal);
      if (newVal != oldVal) {
        if (timeout) {
          $timeout.cancel(timeout)
        }
        timeout = $timeout(saveUpdates, 1000);  // 1000 = 1 second
      }
    };
    $scope.$watch('conference', debounceSaveUpdates, true)
    $scope.$watch('question.question', debounceSaveUpdates)
    $scope.$watch('answers', debounceSaveUpdates, true)
    // END AUTO SAVE
});
</script>
{% endblock %}
