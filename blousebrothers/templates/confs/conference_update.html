{% extends "layout.html" %}
{% load static %}{% load i18n %}
{% load djng_tags %}
{% block title %}{% trans 'Confs' %}{% endblock %}

{% block submenu %}
	<p class="blouse-font">{% trans "Rédaction d'un sujet" %}</p>
{% endblock %}

{% block content %}
<div class="ng-scope" ng-app='djangular-bb'>
<div ng-controller="ConfFormCtrl" class="container" ng-cloak >

    <div class='row'>
	<aside class="col-md-3">
	    {% verbatim %}
	    <div ng-app="myShoppingList" class="bb-card-2 bb-margin" style="max-width:400px;">
	    <header class="bb-container bb-light-grey bb-padding-16">
	    <h3>Questions</h3>
	    </header>
	    <ul class="nav nav-pills  nav-stacked">
		    <li ng-repeat="x in questions" class="bb-padding-16"><a href ng-click="question_selected(x)"><i class="fa fa-comment fa-fw"></i>{{ $index + 1 }} : {{x.question | limitTo: 20}} ...</a></li>
	    </ul>
	    <div class="bb-container bb-light-grey bb-padding-16">
	    <div class="bb-row bb-margin-top">
	    <div class="bb-col s10">
	    	<input placeholder="Saisissez une question ici" ng-model="addMe" class="form-control bb-border bb-padding">
	    </div>
	    <div class="bb-col s2">
	    	<button ng-click="addItem()" class="btn bb-padding bb-green">Ajouter</button>
	    </div>
	    </div>
	    <p class="bb-padding-left bb-text-red">{{errortext}}</p>
	    </div>
	    </div>
	    {% endverbatim %}
	</aside>

	<div id="subject" class="col-md-9" >
	  {% comment %}
	  <form class="form" name="{{ form.form_name }}" novalidate action="{% url 'confs:update' object.slug %}">
          {% csrf_token %}
	  <div id="conference">
            {{ form }}
	  </div>

	  <div class="control-group">
	    <div class="controls">
	            <button ng-click="submit()" class="btn">{% trans "Valider" %}</button>
	    </div>
	  </div>
	  </form>
	  {% endcomment %}

	  {% verbatim %}
	  <legend>Sujet</legend>
	  <form novalidate class="question-form">
	  <input type="text" class="form-control" ng-model="conference.title" placeholder="Titre"/><br />
	  <input type="text" class="form-control" ng-model="conference.statement" placeholder="Énoncé"/><br />
	  </form>
		
	  <legend>Question {{ question.index + 1}}</legend>
	  <form novalidate class="question-form">
	  <input type="text" class="form-control" ng-model="question.question" placeholder="Énoncé"/><br />
	  </form>
		
	  <form class="form-horizontal">
	  <fieldset>
	  <legend>Réponses</legend>
	  <div ng-repeat="answer in answers">
	    <div class="form-group">
	      <div class="col-md-6">
	        <div class="input-group">
			<input ng-model="answer.answer" class="form-control" placeholder="Réponse {{answers.indexOf(answer) + 1}}" required="true" type="text">
		   <input ng-model="anwser.correct" name="checkboxes"  type="checkbox"> Correcte ?
	        </div>
	      </div>
	    </div>
	    <div class="form-group">
	      <div class="col-md-6">
	      <input id="explain_A" name="explain_A" placeholder="Explication" class="form-control input-md" type="text">
	        
	      </div>
	    </div>

	  </div>
	  </fieldset>
	  </form>
 
	  {% endverbatim %}
	</div>
    </div>

</div>
</div>
{% endblock content %}


{% block scripts %}
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.20/angular.min.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.20/angular-resource.min.js" type="text/javascript"></script>
<script src="{% static 'djng/js/django-angular.min.js' %}" type="text/javascript"></script>
<script type="text/javascript">
var conf_crud_service = angular.module('conf_crud_service', ['ngResource']);
var conf_app = angular.module('djangular-bb', ['conf_crud_service', 'djng.forms']);
{% if object %}
var slug="{{ object.slug }}"
{% else %}
var slug=""
{% endif %}

conf_crud_service.factory('Question', ['$resource', function($resource) {
	return $resource('{% url 'confs:question_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_crud_service.factory('Conference', ['$resource', function($resource) {
	return $resource('{% url 'confs:conference_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_crud_service.factory('Answer', ['$resource', function($resource) {
	return $resource('{% url 'confs:answer_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
conf_app.config(function($httpProvider) {
	    $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
	    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
	    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});

conf_app.controller('ConfFormCtrl', function($scope, $http, $window, djangoForm) {
    $scope.submit = function() {
	if ($scope.conf_data) {
		$http.post(".", $scope.conf_data).success(function(out_data) {
			if (!djangoForm.setErrors($scope.conf_form, out_data.errors)) {
				// on successful post, redirect onto success page
				$window.location.href = out_data.success_url;
			}
		}).error(function() {
		console.error('An error occured during submission');
		});
	}
	return false;
    }
});

conf_app.controller("ConfFormCtrl", function($scope, Conference, Question, Answer) {
    $scope.addItem = function () {
        $scope.errortext = "";
        if (!$scope.addMe) {return;}
	$scope.question = new Question()
	$scope.answers = [];
	$scope.questions.push($scope.question);
	$scope.question.index = $scope.questions.indexOf($scope.question);
	$scope.question.conf = $scope.conference.pk;
	$scope.question.question = $scope.addMe;
	$scope.question.$save();
	for (var i=0; i<5; i++) {
    		$scope.answers.push(new Answer({question: $scope.question.id}));
    	}
    }
    $scope.question_selected = function(question){
    	$scope.question = question;
    	$scope.answers = Answer.query({question: question.id});
    }
    $scope.init_model = function () {
	if (slug != ""){
		Conference.get({slug: slug}).$promise
    		.then(function(result){
    			$scope.conference = result;
    			Question.query({conf: $scope.conference.id}).$promise
    			.then(function(result){
				$scope.questions = result;
				$scope.question = $scope.questions[0];
				$scope.answers = Answer.query({question: $scope.question.id});
    			})
    		})
	}
	else{
		$scope.showsubject = true;
	}
    }
    // init model on load
    $scope.init_model();
});
</script>
{% endblock %}
