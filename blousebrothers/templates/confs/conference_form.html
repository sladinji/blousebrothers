{% extends "layout.html" %}
{% load static %}{% load i18n %}
{% load crispy_forms_tags %}
{% load djng_tags %}
{% block title %}{% trans 'Confs' %}{% endblock %}

{% block submenu %}
	<p class="blouse-font">{% trans "Rédaction d'un sujet" %}</p>
{% endblock %}

{% block content %}

<div class="ng-scope" ng-app='djangular-bb'>
<div ng-controller="ConfFormCtrl" class="container">


    <div class='row'>
	<aside class="col-md-3" data-spy="affix">
	    {% verbatim %}
	    <div ng-app="myShoppingList" ng-cloak class="bb-card-2 bb-margin" style="max-width:400px;">
	      <header class="bb-container bb-light-grey bb-padding-16">
	      <h3>Conseils <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> </h3>
	      </header>
	      <ul class="list" > 
		      <li>Faire attention</li>
		      <li>Être concis</li>
	      </ul>
	    </div>
	    {% endverbatim %}
	</aside>

	<div id="subject" class="col-md-9" >
	  <div class="tabbable dashboard col-md-12">

	    <form class="form" name="{{ form.form_name }}" novalidate enctype="multipart/form-data" method="post" action="{% url 'confs:create' %}">
            {% csrf_token %}
	    <div class="tab-content">
	      <div id="conference" ng-show="showsubject" ng-init="showsubject=true">
                {{ form }}
	      </div>
	    </div>

	    <br>
	    <div class="control-group">
	      <div class="controls">
		      <button ng-click="submit()" class="btn">{% trans "Valider" %}</button>
	      </div>
	    </div>
	    </form>
	  </div>
	</div>
    </div>
</div>
</div>


{% endblock content %}

{% block scripts %}
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.20/angular.min.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.20/angular-resource.min.js" type="text/javascript"></script>
<script src="{% static 'djng/js/django-angular.min.js' %}" type="text/javascript"></script>
<script type="text/javascript">
var myServices = angular.module('myServices', ['ngResource']);
var my_app = angular.module('djangular-bb', ['myServices', 'djng.forms']);
{% if object %}
var slug="{{ object.slug }}"
{% else %}
var slug=""
{% endif %}

myServices.factory('Question', ['$resource', function($resource) {
	return $resource('{% url 'confs:question_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
myServices.factory('Conference', ['$resource', function($resource) {
	return $resource('{% url 'confs:conference_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
myServices.factory('Answer', ['$resource', function($resource) {
	return $resource('{% url 'confs:answer_crud_view' %}', {'pk': '@pk'}, {
		        });
}]);
my_app.config(function($httpProvider) {
	    $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
	    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
	    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});

my_app.controller('ConfFormCtrl', function($scope, $http, $window, djangoForm) {
    $scope.submit = function() {
	if ($scope.conf_data) {
		$http.post(".", $scope.conf_data).success(function(out_data) {
			if (!djangoForm.setErrors($scope.conf_form, out_data.errors)) {
				// on successful post, redirect onto success page
				$window.location.href = out_data.success_url;
			}
		}).error(function() {
		console.error('An error occured during submission');
		});
	}
	return false;
    }
});

my_app.controller("ConfFormCtrl", function($scope, Conference, Question, Answer) {
    $scope.addItem = function () {
        $scope.errortext = "";
        if (!$scope.addMe) {return;}
	$scope.question = new Question({
		conf: $scope.conference.id,
		question: $scope.addMe,
	})
	$scope.questions.push(new_model);
	$scope.question.index = $scope.questions.indexOf($scope.question)
	$scope.question.$save(function(){
		$scope.showsubject = false;
	});
    }
    $scope.removeItem = function (x) {
        $scope.errortext = "";    
        $scope.questions.splice(x, 1);
    }
    $scope.init_model = function () {
	if (slug != ""){
		$scope.conference = Conference.get({slug: slug});
		$scope.questions = Question.query({conf : $scope.conference.id});
	}
	else{
		$scope.showsubject = true;
	}
    }
    $scope.init_model();
});
</script>
{% endblock %}
